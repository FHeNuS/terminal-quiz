var TerminalQuiz;!function(t){!function(t){t[t.WrongAnswer="WrongAudio"]="WrongAnswer",t[t.RightAnswer="RightAudio"]="RightAnswer",t[t.Background="BackgroundAudio"]="Background",t[t.QuizTyping="QuizTypingAudio"]="QuizTyping",t[t.UserTyping="UserTypingAudio"]="UserTyping"}(t.QuizSounds||(t.QuizSounds={}));t.QuizSounds}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){this.audioElements={},this.shouldPlayAudioHash={},this.audioLoopHash={},this.audioLoopCounter={}}return t.prototype.createAudioElement=function(t,e){var i=document.createElement("audio");return i.src=e,document.body.appendChild(i),this.audioElements[t]=i,i},t.prototype.isMuted=function(t){return!this.shouldPlayAudioHash[t]},t.prototype.unmute=function(t){this.shouldPlayAudioHash[t]||(this.play(t,!0),this.shouldPlayAudioHash[t]=!0)},t.prototype.mute=function(t){this.shouldPlayAudioHash[t]&&(this.stop(t),this.shouldPlayAudioHash[t]=!1)},t.prototype.addAudio=function(t,e){if(this.getAudio(t,!1))throw new Error("The audio named '"+t+"' was already added!");this.createAudioElement(t,e),this.shouldPlayAudioHash[t]=!0},t.prototype.getAudio=function(t,e){void 0===e&&(e=!0);var i=this.audioElements[t];if(!i&&e)throw new Error('The audio "'+t+"\" could not be found! Are you sure you called the 'addAudio' method?");return i},t.prototype.hasAudio=function(t){return!!this.getAudio(t,!1)},t.prototype.play=function(t,e){if(void 0===e&&(e=!1),t){var i=this.getAudio(t);if(e)if(this.audioLoopHash[t])this.audioLoopCounter[t]++;else{var n=function(){this.currentTime=0,this.play()};this.audioLoopHash[t]=n,this.audioLoopCounter[t]=1,i.addEventListener("ended",n,!1),i.play()}else i.play()}},t.prototype.stop=function(t){if(t){var e=this.getAudio(t);e&&(1==this.audioLoopCounter[t]?(e.pause(),e.currentTime=0,e.removeEventListener("ended",this.audioLoopHash[t],!1),this.audioLoopHash[t]=null):this.audioLoopCounter[t]--)}},t}();t.QuizAudioManager=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t,e){this.element=t,this.opts=e,this.started=!1,this.questions=new Array,this.answers={},this.anim=!1}return e.prototype.separateTextFromElements=function(t,e){var i={elem:t,text:void 0};if(e.push(i),t.style&&(t.style.display="none"),3==t.nodeType&&t.textContent.trim().length>0&&(i.text=t.textContent,t.textContent=""),t.hasChildNodes)for(var n=0;n<t.childNodes.length;n++)this.separateTextFromElements(t.childNodes[n],e)},e.prototype.animatedType=function(e,i){var n=this;if(e.outerHTML.length>0){var o=this.term.get_prompt();this.anim=!0;var r=!1;this.term.set_prompt("");var s=$(e),u=[];this.separateTextFromElements(s.get(0),u),this.term.echo("<i/>",{raw:!0,finalize:function(e){try{if(r)e.append(s);else{r=!0,n.playAudio(t.QuizSounds.QuizTyping,!0),e.empty(),e.append(s);var a=0,h=0,p=null,d=null,c=null,l=n.opts?n.opts.typeMessageDelay:0,f=setInterval(function(){p=u[h],d=p.elem,d.style&&(d.style.display=null),p.text?(c=p.text,d.textContent+=p.text[a++],a==c.length&&(h++,a=0)):h++,h==u.length&&(clearInterval(f),n.stopAudio(t.QuizSounds.QuizTyping),n.anim=!1,n.term.set_prompt(o),i&&i())},l)}}catch(y){console.error("Error on echo",y)}}})}},e.prototype.echo=function(t,e){var i=this;"string"==typeof t&&(t=$('<div class="echo">'+t+"</div>").get(0));var n=this.term.get_command();this.term.set_command(""),this.animatedType(t,function(){i.term.set_command(n),e&&e()})},e.prototype.ask=function(e){if(this.answers[e.getName()])throw new Error("Cannot add a question named '"+e.getName()+"' twice!");return this.questions.push(e),this.answers[e.getName()]=new t.Answer,e},e.prototype.echoFail=function(e){this.echo($('<div class="echo-fail">'+e+"</div>").get(0)),this.playAudio(t.QuizSounds.WrongAnswer);var i=this.getCurrentQuestion();if(i){var n=this.getAnswer(i);n.isValid=!1}},e.prototype.echoSuccess=function(e){this.echo($('<div class="echo-success">'+e+"</div>").get(0)),this.playAudio(t.QuizSounds.RightAnswer)},e.prototype.clear=function(){this.term.clear()},e.prototype.end=function(){if(!this.term)throw new Error("Cannot end the quiz because it did not initialize!");this.stopAudio(t.QuizSounds.Background),this.clear(),this.started=!1,this.onEnd()},e.prototype.getAnswer=function(t){return this.answers[t.getName()]},e.prototype.onKeyPress=function(e){if(this.hasStarted()){var i=this.getCurrentQuestion();return this.playAudio(t.QuizSounds.UserTyping),i.getProcessor().onKeyPress(e.keyCode,this.ctx)}return this.opts.onKeyPress&&this.opts.onKeyPress(e),!1},e.prototype.initialize=function(){var e=this;this.term=window.$(this.element).terminal(function(t,e){},{name:"xxx",keydown:function(t){var i=void 0;e.anim?i=!1:e.onKeyPress(t)?13===t.keyCode&&e.moveToNextQuestion():i=!1},greetings:function(t){t("")},completion:!0,checkArity:!1}),this.ctx={getAnswer:function(){return e.getAnswer(e.getCurrentQuestion())},getTypedCommand:function(){return e.term.get_command()},setTypedCommand:function(t){e.term.set_command(t)},echoFail:function(t){e.echoFail(t)},echoSuccess:function(t){e.echoSuccess(t)},playSound:function(t){e.playAudio(t,!1)}},this.audioManager=new t.QuizAudioManager,this.opts.backgroundSoundUrl&&this.audioManager.addAudio(t.QuizSounds.Background.toString(),this.opts.backgroundSoundUrl),this.opts.rightAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.RightAnswer.toString(),this.opts.rightAnswerSoundUrl),this.opts.wrongAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.WrongAnswer.toString(),this.opts.wrongAnswerSoundUrl),this.opts.userTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.UserTyping.toString(),this.opts.userTypingSoundUrl),this.opts.quizTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.QuizTyping.toString(),this.opts.quizTypingSoundUrl)},e.prototype.start=function(){if(!this.questions||0==this.questions.length)throw new Error("The quiz cannot start because it has no questions!");this.currentQuestionIdx=0,(void 0===this.opts.playBackground||this.opts.playBackground)&&this.playAudio(t.QuizSounds.Background,!0),this.started=!0,this.opts.onStart&&this.opts.onStart(),this.askCurrentQuestion()},e.prototype.hasStarted=function(){return this.started},e.prototype.onQuestionRendered=function(t){t.getProcessor().onRendered(this.ctx),this.opts.onQuestionRendered&&this.opts.onQuestionRendered(t),$(this.element).click(),t.getProcessor().showPrompt()&&$(this.element).find(".cmd").show()},e.prototype.renderQuestion=function(t){var e=this;this.clear(),t.initialize();var i=t.getProcessor().render(this.ctx),n=t.getProcessor().showPrompt();n||$(this.element).find(".cmd").hide(),this.echo(i,function(){e.onQuestionRendered(t)})},e.prototype.shouldAskQuestion=function(t){var e=t.getIfCallback();return!e||e()},e.prototype.askCurrentQuestion=function(){var t=this.getCurrentQuestion();t&&(this.shouldAskQuestion(t)?this.renderQuestion(t):this.moveToNextQuestion())},e.prototype.parseCurrentQuestion=function(){var t=this.getCurrentQuestion(),e=this.getAnswer(t);return e.userAnswer=this.ctx.getTypedCommand(),e.parsedAnswer=this.getCurrentQuestion().getProcessor().parseUserAnswer(e.userAnswer),e},e.prototype.validateCurrentQuestion=function(){var t=this.getCurrentQuestion(),e=this.getAnswer(t);return this.validateAnswer(t,e)},e.prototype.validateAnswer=function(e,i){return i.isValid=!0,e.getProcessor().validateAnswer(i.parsedAnswer,this.ctx),i.isValid?(this.onQuestionAnswered(e),this.playAudio(t.QuizSounds.RightAnswer)):this.playAudio(t.QuizSounds.WrongAnswer),i.isValid},e.prototype.getPreviousQuestionIndex=function(){var t=-1;if(this.currentQuestionIdx>0)for(var e=this.currentQuestionIdx,i=null;e>0&&-1==t;)e--,i=this.questions[e],this.shouldAskQuestion(i)&&(t=e);return e},e.prototype.getNextQuestionIndex=function(){var t=-1;if(this.currentQuestionIdx<this.questions.length-1)for(var e=this.currentQuestionIdx,i=null;e<this.questions.length&&-1==t;)e++,i=this.questions[e],this.shouldAskQuestion(i)&&(t=e);return t},e.prototype.moveToQuestion=function(t){this.parseCurrentQuestion(),this.currentQuestionIdx=t,this.askCurrentQuestion()},e.prototype.moveToNextQuestion=function(){var t=this.getCurrentQuestion(),e=this.parseCurrentQuestion();if(this.validateAnswer(t,e)){var i=this.getNextQuestionIndex();-1==i?this.end():(this.currentQuestionIdx=i,this.askCurrentQuestion())}},e.prototype.getCurrentQuestion=function(){return this.questions[this.currentQuestionIdx]},e.prototype.destroy=function(){this.term&&(this.term.purge(),this.term.destroy())},e.prototype.onQuestionAnswered=function(t){var e=this.getAnswer(t),i=t.getWhenAnsweredCallback();i&&i(e.parsedAnswer),this.opts.onQuestionAnswered&&this.opts.onQuestionAnswered(t,e.parsedAnswer)},e.prototype.onEnd=function(){var t=this.opts.onEnd;t&&t()},e.prototype.playAudio=function(t,e){void 0===e&&(e=!1);var i=t.toString();this.audioManager.hasAudio(i)&&this.audioManager.play(i,e)},e.prototype.stopAudio=function(t){var e=t.toString();this.audioManager.hasAudio(e)&&this.audioManager.stop(e)},e.CMD_SEPARATOR=" ",e}();t.Quiz=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t){this.name=t}return e.prototype.initialize=function(){this.required||(this.required=function(){return!1}),this.ifCallback||(this.ifCallback=function(){return!0}),this.description||(this.description=function(){return null}),this.getProcessor()||this.withProcessor(new t.QuestionProcessor(this))},e.prototype.withTitle=function(t){return this.title=t,this},e.prototype.withDescription=function(t){return this.description=t,this},e.prototype.getDescription=function(){return this.description},e.prototype.getIfCallback=function(){return this.ifCallback},e.prototype.getName=function(){return this.name},e.prototype.getProcessor=function(){return this.processor},e.prototype.getRequired=function(){return this.required},e.prototype.getTitle=function(){return this.title},e.prototype.getWhenAnsweredCallback=function(){return this.whenAnsweredCallback},e.prototype.asRequired=function(t){return void 0===t?this.required=function(){return!0}:"boolean"==typeof t?this.required=function(){return t}:this.required=t,this},e.prototype.onlyAskIf=function(t){return this.ifCallback=t,this},e.prototype.whenAnswered=function(t){return this.whenAnsweredCallback=t,this},e.prototype.withProcessor=function(t){return this.processor=t,this},e}();t.Question=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(t){this.question=t}return t.prototype.showPrompt=function(){return!0},t.prototype.createContainer=function(t,e){return function(){var i=$('<div class="'+t+'">');return"string"==typeof e?i.append(e):i.append(e()),i.get(0)}},t.prototype.render=function(t){var e=$('<div class="'+this.question.constructor.toString().match(/\w+/g)[1]+'"></div>');if(this.question.getTitle()){var i=this.createContainer("question-title",this.question.getTitle());e.append(i)}var n=this.createContainer("question-description",this.question.getDescription());n&&e.append(n);var o=this.getDetail(t);return o&&e.append(o),e.get(0)},t.prototype.getDetail=function(t){return null},t.prototype.onRendered=function(t){},t.prototype.parseUserAnswer=function(t){return t},t.prototype.validateAnswer=function(t,e){var i=!1,n=this.question.getRequired();n&&(i=n()),i&&!t&&e.echoFail("Please provide an answer for this question!")},t.prototype.onKeyPress=function(t,e){return!0},t}();t.QuestionProcessor=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){}return t}();t.Answer=e}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TerminalQuiz;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.withPattern=function(t,e){return this.regex=t,this.friendlyRegex=e,this},e.prototype.getPattern=function(){return this.regex},e.prototype.getFriendlyPattern=function(){return this.friendlyRegex},e.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new i(this)),t.prototype.initialize.call(this)},e}(t.Question);t.TextQuestion=e;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getDetail=function(t){var e=t.getAnswer().userAnswer;return e&&t.setTypedCommand(e),null},e.prototype.validateAnswer=function(e,i){t.prototype.validateAnswer.call(this,e,i);var n=this.question.getPattern();e&&n&&(this.question.getPattern().test(e)||i.echoFail("The answer '"+e+"' does not respect the pattern '"+this.question.getFriendlyPattern()+"'!"))},e}(t.QuestionProcessor);t.TextQuestionProcessor=i,t.Quiz.prototype.askText=function(t){return this.ask(new e(t))}}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TerminalQuiz;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.selectedIdx=0}return __extends(e,t),e.prototype.getDetail=function(t){var e=this,i=t.getAnswer().parsedAnswer;i&&(this.selectedIdx=this.question.getOpts().indexOf(i)),this.container=$('<div class="choices">');var n=$("<ul></ul>").appendTo(this.container);return this.question.getOpts().forEach(function(t,i){n.append('<li class="choice"><span class="cursor"></span><span class="position"></span><span class="name">'+e.question.getOptsName()(t)+"</span></li>")}),this.container.get(0)},e.prototype.onRendered=function(t){this.displaySelectedChoice()},e.prototype.getUserAnswerIdx=function(t){var e=-1;return t>0&&t<=this.question.getOpts().length&&(e=t-1),e},e.prototype.parseUserAnswer=function(t){return this.selectedIdx>=0?this.question.getOpts()[this.selectedIdx]:null},e.prototype.validateAnswer=function(t,e){t||e.echoFail("Please select a valid choice number!")},e.prototype.clearSelectedChoice=function(){this.container.find("li").each(function(t,e){$(e).removeClass("selected")})},e.prototype.displaySelectedChoice=function(){this.clearSelectedChoice(),this.container.find("li").eq(this.selectedIdx).addClass("selected")},e.prototype.onKeyPress=function(t,e){var i=!1;if(38==t)this.selectedIdx>0&&(this.selectedIdx--,this.displaySelectedChoice());else if(40==t)this.selectedIdx<this.question.getOpts().length-1&&(this.selectedIdx++,this.displaySelectedChoice());else if(t>=48&&57>=t||t>=96&&105>=t){var n=t>=96&&105>=t,o=n?""+(t-96):String.fromCharCode(t);if(/^\d$/.test(o)){var r=this.getUserAnswerIdx(parseInt(o));r>=0?(this.selectedIdx=r,this.displaySelectedChoice(),i=!1):e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!")}}else t>=65&&90>=t?e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!"):i=!0;return i},e.prototype.showPrompt=function(){return!1},e}(t.QuestionProcessor);t.ChoiceQuestionProcessor=e;var i=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new e(this)),t.prototype.initialize.call(this),this.nameGetter||(this.nameGetter=function(t){return t.toString()})},i.prototype.getOpts=function(){return this.opts},i.prototype.getOptsName=function(){return this.nameGetter},i.prototype.withOpts=function(t){return this.opts=t,this},i.prototype.withOptsName=function(t){return this.nameGetter=t,this},i}(t.Question);t.ChoiceQuestion=i,t.Quiz.prototype.askChoice=function(t,e){var n=this.ask(new i(t));return e&&n.withOpts(e),n}}(TerminalQuiz||(TerminalQuiz={})),function(t){t.fn.terminalQuiz=function(t){if(this.length>1)throw new Error("Cannot apply the terminal quiz JQuery plugin for multiple elements at once!");var e=new TerminalQuiz.Quiz(this.get(0),t);return e.initialize(),e}}(jQuery);