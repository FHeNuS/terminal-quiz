var TerminalQuiz;!function(t){!function(t){t[t.WrongAnswer="WrongAudio"]="WrongAnswer",t[t.RightAnswer="RightAudio"]="RightAnswer",t[t.Background="BackgroundAudio"]="Background",t[t.QuizTyping="QuizTypingAudio"]="QuizTyping",t[t.UserTyping="UserTypingAudio"]="UserTyping"}(t.QuizSounds||(t.QuizSounds={}));t.QuizSounds}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){this.audioElements={},this.shouldPlayAudioHash={},this.audioLoopHash={},this.audioLoopCounter={}}return t.prototype.createAudioElement=function(t,e){var n=document.createElement("audio");return n.src=e,document.body.appendChild(n),this.audioElements[t]=n,n},t.prototype.isMuted=function(t){return!this.shouldPlayAudioHash[t]},t.prototype.unmute=function(t){this.shouldPlayAudioHash[t]||(this.play(t,!0),this.shouldPlayAudioHash[t]=!0)},t.prototype.mute=function(t){this.shouldPlayAudioHash[t]&&(this.stop(t),this.shouldPlayAudioHash[t]=!1)},t.prototype.addAudio=function(t,e){if(this.getAudio(t,!1))throw new Error("The audio named '"+t+"' was already added!");this.createAudioElement(t,e),this.shouldPlayAudioHash[t]=!0},t.prototype.getAudio=function(t,e){void 0===e&&(e=!0);var n=this.audioElements[t];if(!n&&e)throw new Error('The audio "'+t+"\" could not be found! Are you sure you called the 'addAudio' method?");return n},t.prototype.hasAudio=function(t){return!!this.getAudio(t,!1)},t.prototype.play=function(t,e){if(void 0===e&&(e=!1),t){var n=this.getAudio(t);if(e)if(this.audioLoopHash[t])this.audioLoopCounter[t]++;else{var i=function(){this.currentTime=0,this.play()};this.audioLoopHash[t]=i,this.audioLoopCounter[t]=1,n.addEventListener("ended",i,!1),n.play()}else n.play()}},t.prototype.stop=function(t){if(t){var e=this.getAudio(t);e&&(1==this.audioLoopCounter[t]?(e.pause(),e.currentTime=0,e.removeEventListener("ended",this.audioLoopHash[t],!1),this.audioLoopHash[t]=null):this.audioLoopCounter[t]--)}},t}();t.QuizAudioManager=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t,e){this.element=t,this.opts=e,this.questions=new Array,this.answers={},this.anim=!1}return e.prototype.separateTextFromElements=function(t,e){var n={elem:t,text:void 0};if(e.push(n),t.style&&(t.style.display="none"),3==t.nodeType&&t.textContent.trim().length>0&&(n.text=t.textContent,t.textContent=""),t.hasChildNodes)for(var i=0;i<t.childNodes.length;i++)this.separateTextFromElements(t.childNodes[i],e)},e.prototype.animatedType=function(e,n){var i=this;if(e.outerHTML.length>0){var o=this.term.get_prompt();this.anim=!0;var r=!1;this.term.set_prompt("");var s=$(e),u=[];this.separateTextFromElements(s.get(0),u),this.term.echo("<i/>",{raw:!0,finalize:function(e){try{if(r)e.append(s);else{r=!0,i.playSound(t.QuizSounds.QuizTyping,!0),e.empty(),e.append(s);var a=0,h=0,p=null,d=null,c=null,l=i.opts?i.opts.typeMessageDelay:0,f=setInterval(function(){p=u[h],d=p.elem,d.style&&(d.style.display=null),p.text?(c=p.text,d.textContent+=p.text[a++],a==c.length&&(h++,a=0)):h++,h==u.length&&(clearInterval(f),i.stopSound(t.QuizSounds.QuizTyping),i.anim=!1,i.term.set_prompt(o),n&&n())},l)}}catch(y){console.error("Error on echo",y)}}})}},e.prototype.echo=function(t,e){var n=this;"string"==typeof t&&(t=$('<div class="echo">'+t+"</div>").get(0));var i=this.term.get_command();this.term.set_command(""),this.animatedType(t,function(){n.term.set_command(i),$(n.element).click(),e&&e()})},e.prototype.ask=function(e){if(this.answers[e.getName()])throw new Error("Cannot add a question named '"+e.getName()+"' twice!");return this.questions.push(e),this.answers[e.getName()]=new t.Answer,e},e.prototype.echoFail=function(e,n){this.echo($('<div class="echo-fail"></div>').append(e).get(0),n),this.playSound(t.QuizSounds.WrongAnswer);var i=this.getCurrentQuestion();if(i){var o=this.getAnswer(i);o.isValid=!1}},e.prototype.echoSuccess=function(e,n){this.echo($('<div class="echo-success"></div>').append(e).get(0),n),this.playSound(t.QuizSounds.RightAnswer)},e.prototype.clear=function(){this.term.clear()},e.prototype.end=function(){if(!this.term)throw new Error("Cannot end the quiz because it did not initialize!");this.stopSound(t.QuizSounds.Background),this.clear(),this.onEnd()},e.prototype.getAnswer=function(t){return this.answers[t.getName()]},e.prototype.getQuestions=function(){return this.questions},e.prototype.onKeyPress=function(e){var n=this.getCurrentQuestion();return n?(this.playSound(t.QuizSounds.UserTyping),n.getProcessor().onKeyPress(e.keyCode,this.ctx)):void 0},e.prototype.initialize=function(){var e=this;this.term=window.$(this.element).terminal(function(t,e){},{name:"xxx",keydown:function(t){var n=void 0;e.anim?n=!1:e.onKeyPress(t)?13===t.keyCode&&e.moveToNextQuestion():n=!1},greetings:function(t){t("")},completion:!0,checkArity:!1}),this.ctx={getAnswer:function(){return e.getAnswer(e.getCurrentQuestion())},getTypedCommand:function(){return e.term.get_command()},setTypedCommand:function(t){e.term.set_command(t)},echoFail:function(t){e.echoFail(t)},echoSuccess:function(t){e.echoSuccess(t)},playSound:function(t,n){e.playSound(t,n)},stopSound:function(t){e.stopSound(t)}},this.audioManager=new t.QuizAudioManager,this.opts.backgroundSoundUrl&&this.audioManager.addAudio(t.QuizSounds.Background.toString(),this.opts.backgroundSoundUrl),this.opts.rightAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.RightAnswer.toString(),this.opts.rightAnswerSoundUrl),this.opts.wrongAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.WrongAnswer.toString(),this.opts.wrongAnswerSoundUrl),this.opts.userTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.UserTyping.toString(),this.opts.userTypingSoundUrl),this.opts.quizTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.QuizTyping.toString(),this.opts.quizTypingSoundUrl)},e.prototype.start=function(){if(!this.questions||0==this.questions.length)throw new Error("The quiz cannot start because it has no questions!");this.currentQuestionIdx=0,(void 0===this.opts.playBackground||this.opts.playBackground)&&this.playSound(t.QuizSounds.Background,!0),this.opts.onStart&&this.opts.onStart(),this.askCurrentQuestion()},e.prototype.onQuestionRendered=function(t){t.getProcessor().onRendered(this.ctx),this.opts.onQuestionRendered&&this.opts.onQuestionRendered(t),t.getProcessor().showPrompt()&&$(this.element).find(".cmd").show()},e.prototype.hidePromptIfNeeded=function(t){var e=t.showPrompt();e||$(this.element).find(".cmd").hide()},e.prototype.renderQuestion=function(t){var e=this;this.clear(),t.initialize();var n=t.getProcessor(),i=n.render(this.ctx);this.hidePromptIfNeeded(n),this.echo(i,function(){e.onQuestionRendered(t)})},e.prototype.shouldAskQuestion=function(t){var e=t.getIfCallback();return!e||e()},e.prototype.askCurrentQuestion=function(){var t=this.getCurrentQuestion();t&&(this.shouldAskQuestion(t)?this.renderQuestion(t):this.moveToNextQuestion())},e.prototype.parseCurrentQuestion=function(){var t=this.getCurrentQuestion(),e=this.getAnswer(t);return e.userAnswer=this.ctx.getTypedCommand(),e.parsedAnswer=this.getCurrentQuestion().getProcessor().parseUserAnswer(e.userAnswer),e},e.prototype.validateCurrentQuestion=function(){var t=this.getCurrentQuestion(),e=this.getAnswer(t);return this.validateAnswer(t,e)},e.prototype.validateAnswer=function(e,n){return n.isValid=!0,e.getProcessor().validateAnswer(n.parsedAnswer,this.ctx),n.isValid?(this.onQuestionAnswered(e),this.playSound(t.QuizSounds.RightAnswer)):this.playSound(t.QuizSounds.WrongAnswer),n.isValid},e.prototype.getPreviousQuestionIndex=function(){var t=-1;if(this.currentQuestionIdx>0)for(var e=this.currentQuestionIdx,n=null;e>0&&-1==t;)e--,n=this.questions[e],this.shouldAskQuestion(n)&&(t=e);return e},e.prototype.getNextQuestionIndex=function(){var t=-1;if(this.currentQuestionIdx<this.questions.length-1)for(var e=this.currentQuestionIdx,n=null;e<this.questions.length&&-1==t;)e++,n=this.questions[e],this.shouldAskQuestion(n)&&(t=e);return t},e.prototype.moveToQuestion=function(t){this.parseCurrentQuestion(),this.currentQuestionIdx=t,this.askCurrentQuestion()},e.prototype.moveToNextQuestion=function(){var t=this.getCurrentQuestion(),e=this.parseCurrentQuestion(),n=this.validateAnswer(t,e);if(n){var i=this.getNextQuestionIndex();-1==i?this.end():(this.currentQuestionIdx=i,this.askCurrentQuestion())}return n},e.prototype.getCurrentQuestion=function(){return this.questions[this.currentQuestionIdx]},e.prototype.destroy=function(){this.term&&(this.term.purge(),this.term.destroy())},e.prototype.onQuestionAnswered=function(t){var e=this.getAnswer(t),n=t.getWhenAnsweredCallback();n&&n(e.parsedAnswer),this.opts.onQuestionAnswered&&this.opts.onQuestionAnswered(t,e.parsedAnswer)},e.prototype.onEnd=function(){var t=this.opts.onEnd;t&&t()},e.prototype.playSound=function(t,e){void 0===e&&(e=!1);var n=t.toString();this.audioManager.hasAudio(n)&&this.audioManager.play(n,e)},e.prototype.stopSound=function(t){var e=t.toString();this.audioManager.hasAudio(e)&&this.audioManager.stop(e)},e.CMD_SEPARATOR=" ",e}();t.Quiz=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t){this.name=t}return e.prototype.initialize=function(){this.required||(this.required=function(){return!1}),this.ifCallback||(this.ifCallback=function(){return!0}),this.description||(this.description=function(){return null}),this.getProcessor()||this.withProcessor(new t.QuestionProcessor(this)),this.getRequiredMessage()||this.withRequiredMessage("Please provide an answer for this question!")},e.prototype.withRequiredMessage=function(t){return this.requiredMessage=t,this},e.prototype.withTitle=function(t){return this.title=t,this},e.prototype.withDescription=function(t){return this.description=t,this},e.prototype.getDescription=function(){return this.description},e.prototype.getIfCallback=function(){return this.ifCallback},e.prototype.getName=function(){return this.name},e.prototype.getProcessor=function(){return this.processor},e.prototype.getRequired=function(){return this.required},e.prototype.getRequiredMessage=function(){return this.requiredMessage},e.prototype.getTitle=function(){return this.title},e.prototype.getWhenAnsweredCallback=function(){return this.whenAnsweredCallback},e.prototype.getWhenRenderedCallback=function(){return this.whenRenderedCallback},e.prototype.asRequired=function(t){return void 0===t?this.required=function(){return!0}:"boolean"==typeof t?this.required=function(){return t}:this.required=t,this},e.prototype.onlyAskIf=function(t){return this.ifCallback=t,this},e.prototype.whenAnswered=function(t){return this.whenAnsweredCallback=t,this},e.prototype.whenRendered=function(t){return this.whenRenderedCallback=t,this},e.prototype.withProcessor=function(t){return this.processor=t,this},e}();t.Question=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(t){this.question=t}return t.prototype.showPrompt=function(){return!0},t.prototype.createContainer=function(t,e){return function(){var n=$('<div class="'+t+'">');return"string"==typeof e?n.append(e):n.append(e()),n.get(0)}},t.prototype.render=function(t){var e=$('<div class="'+this.question.constructor.toString().match(/\w+/g)[1]+'"></div>');if(this.question.getTitle()){var n=this.createContainer("question-title",this.question.getTitle());e.append(n)}var i=this.createContainer("question-description",this.question.getDescription());i&&e.append(i);var o=this.getDetail(t);return o&&e.append(o),e.get(0)},t.prototype.getDetail=function(t){return null},t.prototype.onRendered=function(t){var e=this.question.getWhenRenderedCallback();e&&e()},t.prototype.parseUserAnswer=function(t){return t},t.prototype.validateAnswer=function(t,e){var n=!1,i=this.question.getRequired();if(i&&(n=i()),n&&!t){var o=this.question.getRequiredMessage();"string"!=typeof o&&(o=o()),e.echoFail(o)}},t.prototype.onKeyPress=function(t,e){return!0},t}();t.QuestionProcessor=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){}return t}();t.Answer=e}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},TerminalQuiz;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.withPattern=function(t,e){return this.regex=t,this.friendlyRegex=e,this},e.prototype.getPattern=function(){return this.regex},e.prototype.getFriendlyPattern=function(){return this.friendlyRegex},e.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new n(this)),t.prototype.initialize.call(this)},e}(t.Question);t.TextQuestion=e;var n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getDetail=function(t){var e=t.getAnswer().userAnswer;return e&&t.setTypedCommand(e),null},e.prototype.validateAnswer=function(e,n){t.prototype.validateAnswer.call(this,e,n);var i=this.question.getPattern();e&&i&&(this.question.getPattern().test(e)||n.echoFail("The answer '"+e+"' does not respect the pattern '"+this.question.getFriendlyPattern()+"'!"))},e}(t.QuestionProcessor);t.TextQuestionProcessor=n,t.Quiz.prototype.askText=function(t){return this.ask(new e(t))}}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},TerminalQuiz;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.selectedIdx=0}return __extends(n,e),n.prototype.createOption=function(e,n,i,o){var r=this;$('<li class="choice"><span class="cursor"></span><span class="position"></span><span class="name">'+this.question.getOptsName()(e)+"</span></li>").appendTo(i).click(function(){r.selectedIdx=n,r.displaySelectedChoice(),o.playSound(t.QuizSounds.UserTyping)})},n.prototype.getDetail=function(t){var e=this,n=t.getAnswer().parsedAnswer;n&&(this.selectedIdx=this.question.getOpts().indexOf(n)),this.container=$('<div class="choices">');var i=$("<ul></ul>").appendTo(this.container);return this.question.getOpts().forEach(function(n,o){e.createOption(n,o,i,t)}),this.container.get(0)},n.prototype.onRendered=function(t){this.displaySelectedChoice(),e.prototype.onRendered.call(this,t)},n.prototype.getUserAnswerIdx=function(t){var e=-1;return t>0&&t<=this.question.getOpts().length&&(e=t-1),e},n.prototype.parseUserAnswer=function(t){return this.selectedIdx>=0?this.question.getOpts()[this.selectedIdx]:null},n.prototype.validateAnswer=function(t,e){t||e.echoFail("Please select a valid choice number!")},n.prototype.clearSelectedChoice=function(){this.container.find("li").each(function(t,e){$(e).removeClass("selected")})},n.prototype.displaySelectedChoice=function(){this.clearSelectedChoice(),this.container.find("li").eq(this.selectedIdx).addClass("selected")},n.prototype.onKeyPress=function(t,e){var n=!1;if(38==t)this.selectedIdx>0&&(this.selectedIdx--,this.displaySelectedChoice());else if(40==t)this.selectedIdx<this.question.getOpts().length-1&&(this.selectedIdx++,this.displaySelectedChoice());else if(t>=48&&57>=t||t>=96&&105>=t){var i=t>=96&&105>=t,o=i?""+(t-96):String.fromCharCode(t);if(/^\d$/.test(o)){var r=this.getUserAnswerIdx(parseInt(o));r>=0?(this.selectedIdx=r,this.displaySelectedChoice(),n=!1):e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!")}}else t>=65&&90>=t?e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!"):n=!0;return n},n.prototype.showPrompt=function(){return!1},n}(t.QuestionProcessor);t.ChoiceQuestionProcessor=e;var n=function(t){function n(){t.apply(this,arguments)}return __extends(n,t),n.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new e(this)),t.prototype.initialize.call(this),this.nameGetter||(this.nameGetter=function(t){return t.toString()})},n.prototype.getOpts=function(){return this.opts},n.prototype.getOptsName=function(){return this.nameGetter},n.prototype.withOpts=function(t){return this.opts=t,this},n.prototype.withOptsName=function(t){return this.nameGetter=t,this},n}(t.Question);t.ChoiceQuestion=n,t.Quiz.prototype.askChoice=function(t,e){var i=this.ask(new n(t));return e&&i.withOpts(e),i}}(TerminalQuiz||(TerminalQuiz={})),function(t){t.fn.terminalQuiz=function(t){if(this.length>1)throw new Error("Cannot apply the terminal quiz JQuery plugin for multiple elements at once!");var e=new TerminalQuiz.Quiz(this.get(0),t);return e.initialize(),e}}(jQuery);