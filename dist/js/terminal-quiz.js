var TerminalQuiz;!function(t){!function(t){t[t.WrongAnswer="WrongAudio"]="WrongAnswer",t[t.RightAnswer="RightAudio"]="RightAnswer",t[t.Background="BackgroundAudio"]="Background",t[t.QuizTyping="QuizTypingAudio"]="QuizTyping",t[t.UserTyping="UserTypingAudio"]="UserTyping"}(t.QuizSounds||(t.QuizSounds={}));t.QuizSounds}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){this.audioElements={},this.shouldPlayAudioHash={},this.audioLoopHash={},this.audioLoopCounter={}}return t.prototype.createAudioElement=function(t,e){var i=document.createElement("audio");return i.src=e,document.body.appendChild(i),this.audioElements[t]=i,i},t.prototype.isMuted=function(t){return!this.shouldPlayAudioHash[t]},t.prototype.unmute=function(t){this.shouldPlayAudioHash[t]||(this.play(t,!0),this.shouldPlayAudioHash[t]=!0)},t.prototype.mute=function(t){this.shouldPlayAudioHash[t]&&(this.stop(t),this.shouldPlayAudioHash[t]=!1)},t.prototype.addAudio=function(t,e){if(this.getAudio(t,!1))throw new Error("The audio named '"+t+"' was already added!");this.createAudioElement(t,e),this.shouldPlayAudioHash[t]=!0},t.prototype.getAudio=function(t,e){void 0===e&&(e=!0);var i=this.audioElements[t];if(!i&&e)throw new Error('The audio "'+t+"\" could not be found! Are you sure you called the 'addAudio' method?");return i},t.prototype.hasAudio=function(t){return!!this.getAudio(t,!1)},t.prototype.play=function(t,e){if(void 0===e&&(e=!1),t){var i=this.getAudio(t);if(e)if(this.audioLoopHash[t])this.audioLoopCounter[t]++;else{var n=function(){this.currentTime=0,this.play()};this.audioLoopHash[t]=n,this.audioLoopCounter[t]=1,i.addEventListener("ended",n,!1),i.play()}else i.play()}},t.prototype.stop=function(t){if(t){var e=this.getAudio(t);e&&(1==this.audioLoopCounter[t]?(e.pause(),e.currentTime=0,e.removeEventListener("ended",this.audioLoopHash[t],!1),this.audioLoopHash[t]=null):this.audioLoopCounter[t]--)}},t}();t.QuizAudioManager=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t,e){this.element=t,this.opts=e,this.started=!1,this.questions=new Array,this.answers={},this.anim=!1}return e.prototype.separateTextFromElements=function(t,e){if(t.hasChildNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];3==n.nodeType&&n.textContent.trim().length>0&&(e.push({elem:n,text:n.textContent}),n.textContent=""),this.separateTextFromElements(n,e)}},e.prototype.animatedType=function(e,i){var n=this;if(e.outerHTML.length>0){var o=this.term.get_prompt();this.anim=!0;var r=!1;this.term.set_prompt("");var s=$(e),u=[];this.separateTextFromElements(s.get(0),u),this.term.echo("<i/>",{raw:!0,finalize:function(e){try{if(r)e.append(s);else{r=!0,n.playAudio(t.QuizSounds.QuizTyping,!0),e.empty(),e.append(s);var a=0,h=0,c=null,d=null,p=null,l=n.opts?n.opts.typeMessageDelay:0,f=setInterval(function(){c=u[h],d=c.elem,p=c.text,d.textContent+=c.text[a++],a==p.length&&(h++,a=0,h==u.length&&(clearInterval(f),setTimeout(function(){n.stopAudio(t.QuizSounds.QuizTyping),n.anim=!1,n.term.set_prompt(o),i&&i()},l)))},l)}}catch(g){console.error("Error on echo",g)}}})}},e.prototype.echo=function(t){var e=this,i=this.term.get_command();this.term.set_command(""),this.animatedType(t,function(){e.term.set_command(i)})},e.prototype.ask=function(e){if(this.answers[e.getName()])throw new Error("Cannot add a question named '"+e.getName()+"' twice!");return this.questions.push(e),this.answers[e.getName()]=new t.Answer,e},e.prototype.echoFail=function(e){this.echo($('<div class="echo-fail">'+e+"</div>").get(0)),this.playAudio(t.QuizSounds.WrongAnswer);var i=this.getCurrentQuestion();if(i){var n=this.getAnswer(i);n.isValid=!1}},e.prototype.echoSuccess=function(e){this.echo($('<div class="echo-success">'+e+"</div>").get(0)),this.playAudio(t.QuizSounds.RightAnswer)},e.prototype.clear=function(){this.term.clear(),this.term.set_prompt("> ")},e.prototype.end=function(){if(!this.term)throw new Error("Cannot end the quiz because it did not initialize!");if(!this.started)throw new Error("Cannot end the quiz because it did not start!");this.stopAudio(t.QuizSounds.Background),this.clear(),this.started=!1,this.onEnd()},e.prototype.getAnswer=function(t){return this.answers[t.getName()]},e.prototype.onUserCommand=function(t){var e=this.getCurrentQuestion();if(e){var i=this.getAnswer(e);i.userAnswer=t,i.parsedAnswer=this.getCurrentQuestion().getProcessor().parseUserAnswer(i.userAnswer)}},e.prototype.onKeyPress=function(e){this.playAudio(t.QuizSounds.UserTyping);var i=this.getCurrentQuestion();return i?i.getProcessor().onKeyPress(e.keyCode,this.ctx):void 0},e.prototype.validateCurrentAnswer=function(){var t=this.getCurrentQuestion(),e=this.getAnswer(t);return e.isValid=!0,t.getProcessor().validateAnswer(e.parsedAnswer,this.ctx),e.isValid},e.prototype.initialize=function(){var e=this;this.term=window.$(this.element).terminal(function(t,i){e.onUserCommand(t),e.goToNextQuestion()},{name:"xxx",keydown:function(t){return e.anim?!1:e.onKeyPress(t)?void 0:!1},greetings:function(t){t("")},completion:!0,checkArity:!1}),this.ctx={getAnswer:function(){return e.term.get_command()},setAnswer:function(t){e.term.set_command(t)},echoFail:function(t){e.echoFail(t)},echoSuccess:function(t){e.echoSuccess(t)},playSound:function(t){e.playAudio(t,!1)}},this.audioManager=new t.QuizAudioManager,this.opts.backgroundSoundUrl&&this.audioManager.addAudio(t.QuizSounds.Background.toString(),this.opts.backgroundSoundUrl),this.opts.rightAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.RightAnswer.toString(),this.opts.rightAnswerSoundUrl),this.opts.wrongAnswerSoundUrl&&this.audioManager.addAudio(t.QuizSounds.WrongAnswer.toString(),this.opts.wrongAnswerSoundUrl),this.opts.userTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.UserTyping.toString(),this.opts.userTypingSoundUrl),this.opts.quizTypingSoundUrl&&this.audioManager.addAudio(t.QuizSounds.QuizTyping.toString(),this.opts.quizTypingSoundUrl)},e.prototype.start=function(){if(!this.questions||0==this.questions.length)throw new Error("The quiz cannot start because it has no questions!");this.currentQuestionIdx=0,this.playAudio(t.QuizSounds.Background,!0),this.started=!0,this.askCurrentQuestion()},e.prototype.hasStarted=function(){return this.started},e.prototype.askCurrentQuestion=function(){var t=this.getCurrentQuestion();if(t){this.term.clear(),t.initialize();var e=$('<div class="'+t.constructor.toString().match(/\w+/g)[1]+'"></div>'),i=t.getTitle()(),n=t.getDescription()(),o=t.getProcessor().getDetail();e.append(i),n&&e.append(n),o&&e.append(o),this.echo(e.get(0))}},e.prototype.goToNextQuestion=function(){if(!this.started)throw new Error("Cannot go to the next question because the quiz did not start yet! Did you call the start method?");if(this.validateCurrentAnswer()){this.onAnswered(this.getCurrentQuestion()),this.playAudio(t.QuizSounds.RightAnswer);var e=this.currentQuestionIdx==this.questions.length-1;e?this.end():(this.currentQuestionIdx++,this.askCurrentQuestion())}else this.playAudio(t.QuizSounds.WrongAnswer)},e.prototype.getCurrentQuestion=function(){return this.questions[this.currentQuestionIdx]},e.prototype.destroy=function(){this.term&&(this.term.purge(),this.term.destroy())},e.prototype.onAnswered=function(t){},e.prototype.onEnd=function(){},e.prototype.playAudio=function(t,e){void 0===e&&(e=!1);var i=t.toString();this.audioManager.hasAudio(i)&&this.audioManager.play(i,e)},e.prototype.stopAudio=function(t){var e=t.toString();this.audioManager.hasAudio(e)&&this.audioManager.stop(e)},e.CMD_SEPARATOR=" ",e}();t.Quiz=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function e(t){this.name=t}return e.prototype.initialize=function(){if(!this.title||!this.title())throw new Error("The question named '"+this.name+"' does not define a title!");this.required||(this.required=function(){return!1}),this.ifCallback||(this.ifCallback=function(){return!0}),this.description||(this.description=function(){return null}),this.getProcessor()||this.withProcessor(new t.QuestionProcessor(this))},e.prototype.createContainer=function(t,e){return function(){var i=$('<div class="'+t+'">');return"string"==typeof e?i.append(e):i.append(e()),i.get(0)}},e.prototype.withTitle=function(t){return this.title=this.createContainer("title",t),this},e.prototype.withDescription=function(t){return this.description=this.createContainer("description",t),this},e.prototype.getDescription=function(){return this.description},e.prototype.getIfCallback=function(){return this.ifCallback},e.prototype.getName=function(){return this.name},e.prototype.getProcessor=function(){return this.processor},e.prototype.getRequired=function(){return this.required},e.prototype.getTitle=function(){return this.title},e.prototype.getWhenAnsweredCallback=function(){return this.whenAnsweredCallback},e.prototype.asRequired=function(t){return void 0===t?this.required=function(){return!0}:"boolean"==typeof t?this.required=function(){return t}:this.required=t,this},e.prototype.onlyAskIf=function(t){return this.ifCallback=t,this},e.prototype.whenAnswered=function(t){return this.whenAnsweredCallback=t,this},e.prototype.withProcessor=function(t){return this.processor=t,this},e}();t.Question=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(t){this.question=t}return t.prototype.getDetail=function(){return null},t.prototype.parseUserAnswer=function(t){return t},t.prototype.validateAnswer=function(t,e){var i=!1,n=this.question.getRequired();n&&(i=n()),i&&!t&&e.echoFail("Please provide an answer for this question!")},t.prototype.onKeyPress=function(t,e){return console.log(t),!0},t}();t.QuestionProcessor=e}(TerminalQuiz||(TerminalQuiz={}));var TerminalQuiz;!function(t){var e=function(){function t(){}return t}();t.Answer=e}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TerminalQuiz;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.withPattern=function(t,e){return this.regex=t,this.friendlyRegex=e,this},e.prototype.getPattern=function(){return this.regex},e.prototype.getFriendlyPattern=function(){return this.friendlyRegex},e.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new i(this)),t.prototype.initialize.call(this)},e}(t.Question);t.TextQuestion=e;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getDetail=function(){return null},e.prototype.validateAnswer=function(e,i){t.prototype.validateAnswer.call(this,e,i);var n=this.question.getPattern();e&&n&&(this.question.getPattern().test(e)||i.echoFail("The answer '"+e+"' does not respect the pattern '"+this.question.getFriendlyPattern()+"'!"))},e}(t.QuestionProcessor);t.TextQuestionProcessor=i,t.Quiz.prototype.askText=function(){return this.ask(new e(name))}}(TerminalQuiz||(TerminalQuiz={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TerminalQuiz;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getDetail=function(){var t=this;return this.container=$('<ol class="choices"></ul>"'),this.question.getOpts().forEach(function(e){t.container.append('<li class="choice"><span class="cursor"></span><span class="name">'+t.question.getOptsName()(e)+"</span></li>")}),this.container.get(0)},e.prototype.getUserAnswerIdx=function(t){var e=-1,i=parseInt(t);return i>0&&i<=this.question.getOpts().length&&(e=i-1),e},e.prototype.parseUserAnswer=function(t){var e=this.getUserAnswerIdx(t);return-1!=e?this.question.getOpts()[e]:null},e.prototype.validateAnswer=function(t,e){t||e.echoFail("Please select a valid choice number!")},e.prototype.clearSelectedChoice=function(){this.container.children().each(function(t,e){$(e).removeClass("selected")})},e.prototype.displaySelectedChoice=function(){this.clearSelectedChoice(),this.container.children().eq(this.selectedIdx).addClass("selected")},e.prototype.onKeyPress=function(t,e){console.log(t);var i=!1;if(8==t)i=!0,1==e.getAnswer().length&&this.clearSelectedChoice();else if(38==t)this.selectedIdx>0?this.selectedIdx--:this.selectedIdx=this.question.getOpts().length-1,e.setAnswer(""+(this.selectedIdx+1)),this.displaySelectedChoice();else if(40==t)this.selectedIdx<this.question.getOpts().length-1?this.selectedIdx++:this.selectedIdx=0,e.setAnswer(""+(this.selectedIdx+1)),this.displaySelectedChoice();else if(t>=48&&57>=t||t>=96&&105>=t){var n=t>=96&&105>=t,o=n?""+(t-96):String.fromCharCode(t);if(/^\d$/.test(o)){var r=this.getUserAnswerIdx(e.getAnswer()+o);r>-1?(this.selectedIdx=r,this.displaySelectedChoice(),i=!0):e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!")}}else t>=65&&90>=t?e.echoFail("Please type a valid choice number or use the UP and DOWN arrows!"):i=!0;return i},e}(t.QuestionProcessor);t.ChoiceQuestionProcessor=e;var i=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.initialize=function(){this.getProcessor()||this.withProcessor(new e(this)),t.prototype.initialize.call(this),this.nameGetter||(this.nameGetter=function(t){return t.toString()})},i.prototype.getOpts=function(){return this.opts},i.prototype.getOptsName=function(){return this.nameGetter},i.prototype.withOpts=function(t){return this.opts=t,this},i.prototype.withOptsName=function(t){return this.nameGetter=t,this},i}(t.Question);t.ChoiceQuestion=i}(TerminalQuiz||(TerminalQuiz={}));